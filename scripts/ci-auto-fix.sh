#!/bin/bash
# Script de correction automatique pour CI/CD et dÃ©veloppement local
# Ce script corrige automatiquement les erreurs de linting et peut crÃ©er un commit

set -e

echo "========================================"
echo "MCParr - CI Auto-Fix & Commit"
echo "========================================"

cd "$(dirname "$0")/.."

AUTO_COMMIT="${AUTO_COMMIT:-false}"
BRANCH_NAME="${CI_COMMIT_BRANCH:-$(git rev-parse --abbrev-ref HEAD)}"
CHANGES_MADE=false

# ============================================================================
# Backend Fixes
# ============================================================================
if [ -d "src/backend" ]; then
    echo ""
    echo "ðŸ Backend - Correction automatique..."
    cd src/backend

    if command -v poetry &> /dev/null; then
        # Sauvegarde l'Ã©tat avant les corrections
        git diff --name-only > /tmp/before_backend.txt 2>/dev/null || true

        # Corrections automatiques
        echo "  â†’ Ruff auto-fix (safe + unsafe)..."
        poetry run ruff check src/ --fix --unsafe-fixes || true

        echo "  â†’ Black formatage..."
        poetry run black src/ || true

        # GÃ©nÃ©ration des rapports
        echo "  â†’ GÃ©nÃ©ration des rapports..."
        mkdir -p reports
        poetry run ruff check src/ --output-format=json > reports/ruff-report.json 2>&1 || true
        poetry run ruff check src/ --output-format=text > reports/ruff-report.txt 2>&1 || true

        # Compte les erreurs restantes
        REMAINING_ERRORS=$(poetry run ruff check src/ 2>&1 | grep -c "Found.*errors" || echo "0")

        echo "  â„¹ï¸  Erreurs restantes: $REMAINING_ERRORS"

        # VÃ©rifie s'il y a eu des changements
        git diff --name-only > /tmp/after_backend.txt 2>/dev/null || true
        if ! diff /tmp/before_backend.txt /tmp/after_backend.txt > /dev/null 2>&1; then
            CHANGES_MADE=true
            echo "  âœ… Corrections appliquÃ©es au backend"
        else
            echo "  â„¹ï¸  Aucun changement au backend"
        fi
    else
        echo "  âš ï¸  Poetry non trouvÃ©"
    fi

    cd ../..
fi

# ============================================================================
# Frontend Fixes
# ============================================================================
if [ -d "src/frontend" ]; then
    echo ""
    echo "ðŸŽ¨ Frontend - Correction automatique..."
    cd src/frontend

    if command -v npm &> /dev/null; then
        # Sauvegarde l'Ã©tat avant les corrections
        git diff --name-only > /tmp/before_frontend.txt 2>/dev/null || true

        # Corrections automatiques
        echo "  â†’ ESLint auto-fix..."
        npm run lint -- --fix 2>/dev/null || echo "  â„¹ï¸  Erreurs rÃ©siduelles"

        # GÃ©nÃ©ration des rapports
        echo "  â†’ GÃ©nÃ©ration des rapports..."
        mkdir -p reports
        npm run lint -- --format json --output-file reports/eslint-report.json 2>/dev/null || true
        npm run lint -- --format stylish > reports/eslint-report.txt 2>/dev/null || true

        # VÃ©rifie s'il y a eu des changements
        git diff --name-only > /tmp/after_frontend.txt 2>/dev/null || true
        if ! diff /tmp/before_frontend.txt /tmp/after_frontend.txt > /dev/null 2>&1; then
            CHANGES_MADE=true
            echo "  âœ… Corrections appliquÃ©es au frontend"
        else
            echo "  â„¹ï¸  Aucun changement au frontend"
        fi
    else
        echo "  âš ï¸  npm non trouvÃ©"
    fi

    cd ../..
fi

# ============================================================================
# Auto-commit (si activÃ©)
# ============================================================================
if [ "$AUTO_COMMIT" = "true" ] && [ "$CHANGES_MADE" = "true" ]; then
    echo ""
    echo "ðŸ“ CrÃ©ation d'un commit avec les corrections..."

    git config user.name "${GIT_USER_NAME:-GitLab CI}"
    git config user.email "${GIT_USER_EMAIL:-ci@gitlab.com}"

    git add -A

    COMMIT_MSG="chore: auto-fix linting errors

- Applied ruff --fix and black formatting (backend)
- Applied eslint --fix (frontend)

ðŸ¤– Auto-generated by CI pipeline
Branch: ${BRANCH_NAME}
Pipeline: ${CI_PIPELINE_URL:-local}"

    git commit -m "$COMMIT_MSG" || echo "âš ï¸ Rien Ã  commiter"

    # Push si dans le CI
    if [ -n "$CI" ] && [ -n "$CI_REPOSITORY_URL" ]; then
        echo "  â†’ Push vers ${BRANCH_NAME}..."
        git push "https://gitlab-ci-token:${CI_JOB_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git" "HEAD:${BRANCH_NAME}"
        echo "  âœ… Changements poussÃ©s vers GitLab"
    else
        echo "  â„¹ï¸  Mode local - les changements ne sont pas poussÃ©s"
        echo "  â„¹ï¸  ExÃ©cutez 'git push' pour envoyer les corrections"
    fi
else
    echo ""
    if [ "$CHANGES_MADE" = "false" ]; then
        echo "âœ… Aucune correction nÃ©cessaire"
    else
        echo "â„¹ï¸  Corrections appliquÃ©es localement"
        echo "â„¹ï¸  Utilisez AUTO_COMMIT=true pour commiter automatiquement"
    fi
fi

echo ""
echo "========================================"
echo "âœ… Auto-fix terminÃ©!"
echo "========================================"

# Affiche le statut git
if command -v git &> /dev/null; then
    echo ""
    git status --short
fi
